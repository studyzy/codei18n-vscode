# 功能规范: Rust源码注释翻译支持

**功能分支**: `002-rust-comment-translation`
**创建时间**: 2025-12-17
**状态**: 草稿
**输入**: 用户描述: "当前已经实现了打开Go代码时将注释显示为对应的中文。现在我需要扩展本VSCode插件,增加对Rust源码的支持,当打开Rust代码时也是把英文注释显示为对应的中文。"

## 用户场景与测试 *(必填)*

### 用户故事 1 - Rust文件自动翻译注释 (优先级: P1)

Rust开发者在VSCode中打开Rust源代码文件(.rs文件)时,所有英文注释(包括行注释`//`和块注释`/* */`)自动显示为对应的中文翻译,与当前Go语言注释翻译功能保持一致的体验。

**优先级原因**: 这是核心功能,提供与Go语言相同的基础翻译能力,使Rust开发者能够立即从插件中获得价值。没有这个功能,扩展Rust支持就没有意义。

**独立测试**: 可以通过打开任意包含英文注释的Rust文件,验证注释是否自动翻译为中文并正确显示,完全独立于其他功能。

**验收场景**: 

1. **给定** 用户安装了插件并启用了CodeI18n功能, **当** 用户在VSCode中打开一个包含英文行注释(`// This is a comment`)的Rust文件, **那么** 该注释自动在编辑器中显示为中文翻译(如`// 这是一个注释`)
2. **给定** 用户正在查看Rust文件, **当** 该文件包含块注释(`/* Block comment */`), **那么** 块注释内容也显示为中文翻译
3. **给定** 用户打开Rust文件, **当** 文件中包含文档注释(`/// Documentation comment`和`//! Module docs`), **那么** 这些文档注释也正确翻译为中文
4. **给定** 用户切换编辑器标签页, **当** 从Go文件切换到Rust文件时, **那么** 两种语言的注释都能正确显示对应的中文翻译

---

### 用户故事 2 - Rust注释实时更新翻译 (优先级: P2)

用户在编辑Rust代码时,当添加或修改英文注释后,翻译能够自动更新,无需手动刷新或重新打开文件。

**优先级原因**: 提升用户体验,使翻译功能更加流畅自然。虽然重要,但用户可以通过重新打开文件来临时获得更新的翻译,因此优先级低于基础翻译功能。

**独立测试**: 可以通过在Rust文件中添加新注释或修改现有注释,观察翻译是否在短时间内自动更新来独立验证。

**验收场景**: 

1. **给定** 用户正在编辑Rust文件, **当** 用户输入新的英文注释并停止输入, **那么** 在合理的延迟时间内(如1-2秒),新注释自动显示中文翻译
2. **给定** 用户已有的注释有翻译, **当** 用户修改该注释的英文内容, **那么** 翻译自动更新为新内容的中文翻译
3. **给定** 用户删除了某个注释, **当** 注释被删除后, **那么** 对应的翻译装饰也立即消失

---

### 用户故事 3 - Rust注释悬停提示 (优先级: P3)

用户将鼠标悬停在Rust代码的注释上时,可以看到包含原始英文和中文翻译的悬停提示框,方便对照查看。

**优先级原因**: 这是增强功能,提供更好的用户体验,但不是核心功能。用户已经可以在编辑器中直接看到翻译,悬停提示只是提供额外的便利。

**独立测试**: 可以通过将鼠标悬停在Rust注释上,验证是否显示包含原文和译文的提示框来独立测试。

**验收场景**: 

1. **给定** 用户正在查看包含翻译注释的Rust文件, **当** 用户将鼠标悬停在某个注释上, **那么** 显示一个提示框,同时展示原始英文和中文翻译
2. **给定** 用户悬停在注释上, **当** 提示框显示时, **那么** 提示框的格式清晰易读,原文和译文有明显区分

---

### 边界情况

- 当Rust文件包含非ASCII字符的注释(如已经包含中文)时,系统如何处理?是否仍然尝试翻译?
- 当Rust文件包含非常长的注释块(如超过1000行)时,系统性能如何?翻译是否会延迟?
- 当codei18n命令行工具不支持Rust或返回错误时,系统如何优雅降级?是否显示错误消息还是保持原文?
- 当用户同时打开多个Rust文件并快速切换时,翻译是否会混乱或出现竞态条件?
- 当Rust注释中包含代码示例或特殊格式(如markdown)时,翻译是否保留格式?
- 当用户禁用插件后再重新启用时,Rust文件的翻译是否能正确恢复?

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统必须识别并处理Rust语言文件(.rs扩展名)
- **FR-002**: 系统必须检测Rust文件中的所有类型注释,包括行注释(`//`)、块注释(`/* */`)、文档注释(`///`、`//!`)和外部文档注释(`/** */`)
- **FR-003**: 系统必须将Rust注释的原始英文文本传递给codei18n命令行工具进行翻译
- **FR-004**: 系统必须在编辑器中以装饰(decoration)形式显示翻译后的中文注释,覆盖或紧邻原始英文注释
- **FR-005**: 系统必须在用户打开Rust文件时自动触发翻译流程
- **FR-006**: 系统必须在用户切换到Rust文件编辑器标签页时触发翻译更新
- **FR-007**: 系统必须在用户编辑Rust文件内容后,延迟一定时间(如500毫秒)后自动重新触发翻译,避免频繁调用
- **FR-008**: 系统必须为Rust文件注册悬停提示提供器(hover provider),当用户悬停在注释上时显示原文和译文
- **FR-009**: 系统必须在插件配置中将`activationEvents`扩展为包含`onLanguage:rust`
- **FR-010**: 系统必须保持与现有Go语言翻译功能一致的用户体验和配置选项
- **FR-011**: 系统必须在遇到翻译错误时优雅降级,保留原始英文注释,不影响编辑器正常使用
- **FR-012**: 系统必须支持用户通过配置启用或禁用Rust翻译功能

### 关键实体 *(如果功能涉及数据则包含)*

- **Rust文档**: 表示VSCode中打开的Rust源代码文件(.rs),包含languageId为'rust'的文本文档对象
- **Rust注释**: 表示从Rust源码中提取的注释文本及其在文档中的位置范围,包括注释类型(行注释、块注释、文档注释)
- **翻译结果**: 表示codei18n CLI工具返回的注释翻译数据,包含原始文本、翻译文本和位置信息
- **装饰对象**: 表示应用于编辑器的视觉装饰,用于显示翻译后的中文注释,包含范围和渲染选项

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 用户打开包含至少10条英文注释的Rust文件后,所有注释在3秒内显示中文翻译
- **SC-002**: 用户在Rust文件中添加或修改注释后,翻译在停止输入后2秒内自动更新
- **SC-003**: 系统处理包含超过100条注释的Rust文件时,编辑器响应时间不超过5秒,不影响正常编辑
- **SC-004**: 90%的Rust文档注释(包括`///`和`//!`)能够正确识别并翻译
- **SC-005**: 悬停提示在鼠标悬停后500毫秒内显示,展示清晰的原文和译文对比
- **SC-006**: 用户在Go文件和Rust文件之间切换时,两种语言的翻译都能在切换后3秒内正确显示
- **SC-007**: 当codei18n工具不可用或返回错误时,系统在1秒内优雅降级,保留原始注释,不崩溃或卡死编辑器
