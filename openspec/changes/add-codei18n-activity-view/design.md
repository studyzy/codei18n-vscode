# 设计：CodeI18n 侧边栏视图与本地化模式

## 范围
本设计文件聚焦于 VS Code 扩展侧的新视图/命令设计及与 `codei18n` CLI 的集成方式，不涉及 CLI 内部实现。

## VS Code 视图与命令设计

### 视图形态选择
为保持实现简单，本次变更采用 VS Code 原生 `TreeView` + 命令模式构建 CodeI18n 侧边栏视图，而非完整 Webview：
- 在 `package.json` 中新增一个 Activity Bar 视图容器（`viewsContainers.activitybar`），图标为 CodeI18n；
- 在该容器下声明一个 `views` 侧边栏视图（如 `codei18n.sidebar`）；
- 在扩展激活时注册一个 `TreeDataProvider`（如 `CodeI18nViewProvider`），按固定结构返回一组可点击的“操作项”。

这一方案的优点是：
- 依赖 VS Code 原生能力，无需处理 Webview 生命周期和 HTML/JS 资源加载；
- 每个节点对应一个命令，易于在 `tasks.md` 和测试中验证；
- 未来如果需要更复杂的 UI，可以在保持命令不变的前提下替换视图实现。

### 视图内容结构
TreeView 的根节点示例结构：
- "初始化本项目"
- "源码本地化方式"
  - "显示本地化（当前模式）"
  - "文件内容本地化"
- "英文化（恢复英文注释）"

交互约定：
- 点击“初始化本项目”：执行绑定命令，调用 CLI 或在工作区生成必要的 `.codei18n` 配置文件；若项目已初始化，可给出提示而不重复执行。
- 点击“显示本地化”：将模式切换为“显示本地化”，更新配置并在视图中标记该模式为当前模式；不直接执行转换命令。
- 点击“文件内容本地化”：将模式切换为“文件内容本地化”，并在视图中标记当前模式；实际批量转换通过单独的按钮触发（见下）。
- 点击“英文化（恢复英文注释）”：触发对源码的反向转换操作，执行 CLI `convert` 到英文。

为避免混淆，“模式”（显示/文件内容）与“动作”（真正执行转换）可以分离：
- 模式：决定默认使用哪种本地化方式（当前实现只影响解释/提示，后续可作为其他行为的输入）。
- 动作：单独提供“执行文件内容本地化”“执行英文化”操作节点，明确区分“配置”和“执行”。如果在实现阶段发现结构过于复杂，可以在未来增量中重构为更细致的分组。

### 配置与状态管理
- 使用现有的 `ConfigManager` 扩展一项配置，例如：`codei18n.localizationMode`，取值：`"display" | "file"`。
- 视图提供者读取该配置以确定当前模式，并在节点文案中体现（例如在当前模式后添加“(当前)”标记）。
- 切换模式命令通过 `vscode.workspace.getConfiguration('codei18n').update('localizationMode', ...)` 持久化到用户或工作区设置。

## CLI 集成设计

### 新增转换调用封装
现有 `CliWrapper` 仅封装了 `scan` 命令。本次变更中，将新增一个转换相关的封装：

- 方法示意：
  - `convertDirectory(options: { toLanguage: string; directory?: string }): Promise<void>`
  - 其中：
    - `toLanguage`：目标语言，例如 `zh-CN`（本地化）、`en`（英文化）；
    - `directory`：要执行转换的目录，默认使用当前工作区根目录。
- 调用 `codei18n` CLI：
  - 本地化：`codei18n convert -to <toLanguage> -d <directory>`；
  - 英文化：依赖 CLI 提供的对应参数（假设为 `-to en`），不在扩展内部自行维护映射。
- 执行时：
  - 使用 `vscode.workspace.workspaceFolders[0].uri.fsPath` 作为默认工作目录；
  - 通过 `cp.spawn` 或 `cp.exec` 执行命令，监听标准输出/错误，并在 VS Code 中以信息/错误消息反馈给用户；
  - 对非零退出码给出友好错误提示。

### 安全与用户确认
由于转换操作会修改源码，本设计要求：
- 在执行任何 `convert` 操作前，使用 `vscode.window.showWarningMessage` 弹出带有明确风险说明的确认对话框，例如：
  - “此操作将批量修改当前工作区中的注释文本，建议先在版本控制中创建提交。是否继续？”
- 用户明确点击“继续”后才执行 CLI 调用；若取消则不进行任何修改。
- 对于没有打开工作区、或 CLI 未正确配置/安装的情况，应尽早报错并阻止执行。

## 初始化项目操作设计
- 在“初始化本项目”命令中，通过 CLI 或直接在工作区生成 CodeI18n 所需的基础文件（例如 `.codei18n` 目录和配置文件）。
- 若 `codei18n` 自身提供了 `init` 命令，优先通过 CLI 调用；否则在实现阶段根据主项目 README/文档确定最小可行的初始化操作。
- 初始化成功后，通过信息提示引导用户下一步操作（例如配置 LLM Provider、API Key 等）。

## 测试与可验证性
- 为视图提供者和新命令编写扩展级测试，覆盖：
  - 视图是否能在激活后正确注册；
  - 不同配置下视图节点文案与当前模式标记是否正确；
  - 执行命令时能否正确调用 `CliWrapper` 中对应的方法。
- 对 CLI 封装方法编写单元测试，通过 sinon 等工具模拟 `child_process` 调用与不同退出码行为。
- 针对“执行本地化”和“英文化”操作增加回归测试场景，确保在 CLI 不可用/工作区为空等情况下不会导致扩展崩溃。